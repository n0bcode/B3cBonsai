@{
	ViewData["Title"] = "Index";
	Layout = "~/Areas/Employee/Views/Shared/_Layout.cshtml";
}

<div class="content-body">
	<!-- row -->
	<div class="page-titles">
		<ol class="breadcrumb">
			<li class="breadcrumb-item">
				<a href="javascript:void(0)">
					<svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path d="M2.125 6.375L8.5 1.41667L14.875 6.375V14.1667C14.875 14.5424 14.7257 14.9027 14.4601 15.1684C14.1944 15.4341 13.8341 15.5833 13.4583 15.5833H3.54167C3.16594 15.5833 2.80561 15.4341 2.53993 15.1684C2.27426 14.9027 2.125 14.5424 2.125 14.1667V6.375Z" stroke="#2C2C2C" stroke-linecap="round" stroke-linejoin="round" />
						<path d="M6.375 15.5833V8.5H10.625V15.5833" stroke="#2C2C2C" stroke-linecap="round" stroke-linejoin="round" />
					</svg>
					Trang chủ
				</a>
			</li>
			<li class="breadcrumb-item active"><a href="javascript:void(0)">Quản lý combo sản phẩm</a></li>
		</ol>
	</div>
	<div class="container-fluid">
		<div class="row">
			<div class="col-xxl-3 col-xl-4" id="viewFormUpsert" >
				@await Html.PartialAsync("Upsert")
			</div>
			<div class="col-xxl-9 col-xl-8">
				<div class="card">
					<div class="card-body p-0">
						<div class="table-responsive active-projects manage-client">
							<div class="tbl-caption">

								<button class="btn btn-success rounded" onclick="loadViewUpsert('')">+ Thêm</button>
							</div>
							<div class="table-responsive p-3 datatables">
								<table id="empoloyees-tbl1" class="table display">
									<thead>
									</thead>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	 <!-- Thêm thư viện jQuery và Select2 -->
	<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

	<script>

		$(document).ready(function () {
			// Khởi tạo Select2 với giới hạn lựa chọn
			$('#sanPhamSelect').select2({
				maximumSelectionLength: 5
			});

			// Xử lý khi chọn sản phẩm
			$('#sanPhamSelect').on('change', function () {
				var selectedProducts = $(this).val();
				$('#chiTietComboContainer').empty(); // Xóa các trường nhập cũ

				// Tạo trường nhập số lượng cho từng sản phẩm
				selectedProducts.forEach(function (productId) {
					var productName = $('#sanPhamSelect option[value="' + productId + '"]').text();
					$('#chiTietComboContainer').append(`
							<div class="form-group mb-3">
								<label>${productName} - Số lượng:</label>
								<input type="number" name="soLuong[${productId}]" min="1" class="form-control" placeholder="Nhập số lượng">
							</div>
						`);
				});
			});
		});

		function actionUpsertCombo(event) {
    event.preventDefault();

    var formData = new FormData(document.getElementById('formUpsertCombo'));

    // Kiểm tra và log dữ liệu FormData
    $('#chiTietComboContainer input[type="number"]').each(function () {
        var productId = $(this).attr("name").match(/\d+/)[0];
        var quantity = $(this).val();
        formData.append(`soLuong[${productId}]`, quantity);
    });

    // Kiểm tra dữ liệu đã được thêm vào formData đúng chưa
    for (var pair of formData.entries()) {
        console.log(pair[0]+ ', ' + pair[1]); 
    }

    $.ajax({
        url: `/Employee/ManagerCombo/Upsert`,
        data: formData,
        method: 'POST',
        processData: false, // Không xử lý dữ liệu
        contentType: false, // Không cần thiết lập contentType
        success: (data) => {
            if (data.success) {
                toastr.success(data.message);
            } else {
                $('#viewFormUpsert').html(data.data);
                toastr.error(data.message);
            }
        },
        error: (xhr) => {
            toastr.error("Có lỗi xảy ra: " + xhr.responseText);
        }
    });
}

	</script>

	<script src="~/js/employee/managerCombo.js" asp-append-version="true"></script>
}